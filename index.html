<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Tap para Volar ‚Äî Juego Minimalista</title>
  <style>
    :root {
      --bg: #0e0f12;
      --fg: #e5e7eb;
      --accent: #7c3aed;
      --muted: #9ca3af;
      --danger: #ef4444;
      --ok: #10b981;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      position: fixed; inset: 0; display: grid; place-items: center;
    }
    canvas {
      width: min(100vw, 700px);
      height: min(100vh, 1000px);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
      touch-action: none;
      background: radial-gradient(1200px 800px at 70% -10%, #1f2430, var(--bg));
      display: block;
    }
    .hud {
      position: fixed; inset: 0; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 10px;
    }
    .topbar {
      display: flex; gap: 12px; align-items: center; justify-content: center; font-weight: 600; letter-spacing: .3px;
    }
    .pill { pointer-events: auto; user-select: none; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); padding: 6px 10px; border-radius: 999px; font-size: 14px; }
    .btn { cursor: pointer; transition: transform .08s ease; }
    .btn:active { transform: translateY(1px) scale(.98); }
    .center {
      position: absolute; inset: 0; display: grid; place-items: center; pointer-events: none;
    }
    .card {
      pointer-events: auto; background: rgba(17, 24, 39, .72);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px; padding: 18px 16px; width: min(92vw, 420px);
      box-shadow: 0 15px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(8px);
    }
    .title { font-size: 20px; font-weight: 800; margin: 0 0 6px; }
    .muted { color: var(--muted); font-size: 14px; line-height: 1.4; }
    .actions { display:flex; gap: 10px; margin-top: 14px; }
    .primary { background: var(--accent); border: none; color: white; padding: 10px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; flex: 1; }
    .secondary { background: transparent; border: 1px solid rgba(255,255,255,.2); color: var(--fg); padding: 10px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; flex: 1; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.14); border-radius: 6px; padding: 2px 6px; }
    #countdownOverlay {
      font-size: 80px;
      font-weight: bold;
      color: var(--accent);
      text-shadow: 0 0 10px rgba(124, 58, 237, 0.5);
      opacity: 0;
      transform: scale(0.5);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    #countdownOverlay.show {
      opacity: 1;
      transform: scale(1);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
  <script src="https://sheetdb.io/handlebars.js"></script>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="360" height="600" aria-label="Juego minimalista: tap para volar"></canvas>
    <img id="playerImage" src="assets/player.png" style="display:none;" alt="Personaje del jugador">
  </div>

  <div class="hud" aria-hidden="true">
    <div class="topbar">
      <div class="pill">Puntos: <span id="score">0</span></div>
      <div class="pill">Mejor: <span id="best">0</span></div>
      <div class="pill btn" id="pauseBtn" title="P o Pausa">‚è∏ Pausa</div>
      <div class="pill btn" id="restartBtn" title="R o Reiniciar">‚Üª Reiniciar</div>
      <div class="pill btn" id="homeBtn" title="H o Inicio">üè† Inicio</div>
    </div>
    <div class="center" id="startOverlay">
      <div class="card">
        <h2 class="title">Tap para Volar</h2>
        <p class="muted">Ingresa tu nombre:</p>
        <input type="text" id="playerNameInput" placeholder="Tu nombre" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); color:var(--fg); margin-bottom:12px;">
        <p class="muted">
          Presiona / toca para mantenerte en el aire y pasa entre los obst√°culos.
          <br/>PC: <span class="kbd">Espacio</span>, <span class="kbd">Click</span>
          ¬∑ M√≥vil: <span class="kbd">Tap</span>
          <br/>Pausa: <span class="kbd">P</span> ¬∑ Reiniciar: <span class="kbd">R</span> ¬∑ Inicio: <span class="kbd">H</span>
        </p>
        <div class="actions">
          <button class="primary" id="startBtn">Jugar</button>
          <button class="secondary" id="muteBtn">Sonido: Off</button>
          <button class="secondary" id="leaderboardBtn">Ver Puntajes</button>
        </div>
      </div>
    </div>
    <div class="center" id="gameOverOverlay" style="display:none">
      <div class="card">
        <h2 class="title">¬°Fin del juego!</h2>
        <p class="muted">Puntuaci√≥n: <b id="finalScore">0</b> ¬∑ Mejor: <b id="finalBest">0</b></p>
        <div class="actions">
          <button class="primary" id="playAgainBtn">Jugar de nuevo</button>
          <button class="secondary" id="homeGameOverBtn">üè† Inicio</button>
        </div>
      </div>
    </div>
    <div class="center" id="leaderboardOverlay" style="display:none">
      <div class="card" style="max-height:80vh; overflow-y:auto;">
        <h2 class="title">Puntajes</h2>
        <table id="leaderboardTable" style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead>
            <tr style="border-bottom:1px solid rgba(255,255,255,.1);">
              <th style="text-align:left; padding:8px;">Nombre</th>
              <th style="text-align:right; padding:8px;">Puntaje</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="closeLeaderboardBtn">Cerrar</button>
        </div>
      </div>
    </div>
    <div class="center" id="countdownOverlay" style="display:none; z-index:10;"></div>
  </div>

  <script>
    const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/fuuxz7yb72qrc';
    let playerName = '';

    (function(){
      const canvas = document.getElementById('game');
      const ctx = canvas.getContext('2d');
      const playerImage = document.getElementById('playerImage');
      let imageLoaded = false;
      playerImage.onload = () => { imageLoaded = true; };
      playerImage.onerror = () => { console.error('Error al cargar la imagen del jugador'); };

      // HUD
      const scoreEl = document.getElementById('score');
      const bestEl = document.getElementById('best');
      const pauseBtn = document.getElementById('pauseBtn');
      const restartBtn = document.getElementById('restartBtn');
      const homeBtn = document.getElementById('homeBtn');
      const startOverlay = document.getElementById('startOverlay');
      const gameOverOverlay = document.getElementById('gameOverOverlay');
      const startBtn = document.getElementById('startBtn');
      const muteBtn = document.getElementById('muteBtn');
      const playAgainBtn = document.getElementById('playAgainBtn');
      const homeGameOverBtn = document.getElementById('homeGameOverBtn');
      const leaderboardBtn = document.getElementById('leaderboardBtn');
      const leaderboardOverlay = document.getElementById('leaderboardOverlay');
      const leaderboardTable = document.getElementById('leaderboardTable').querySelector('tbody');
      const closeLeaderboardBtn = document.getElementById('closeLeaderboardBtn');
      const countdownOverlay = document.getElementById('countdownOverlay');

      // DPR para nitidez en pantallas m√≥viles/retina
      function fitCanvas(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        const cssW = Math.min(window.innerWidth, 700);
        const cssH = Math.min(window.innerHeight, 1000);
        canvas.style.width = cssW + 'px';
        canvas.style.height = cssH + 'px';
        canvas.width = Math.round(cssW * dpr);
        canvas.height = Math.round(cssH * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      fitCanvas();
      window.addEventListener('resize', fitCanvas);

      // Estado del juego
      let state = 'idle';
      let score = 0;
      let best = Number(localStorage.getItem('tapfly_best') || 0);
      bestEl.textContent = best;
      let muted = true;
      let currentLevel = 0;

      // Jugador
      const player = {
        x: 90,
        y: 300,
        r: 12,
        vy: 0,
      };

      // F√≠sicas
      const GRAVITY = 0.25;
      const FLAP = -10;
      const FLOOR = 99999;

      // Obst√°culos (tubos)
      const pipes = [];
      let pipeTimer = 0;
      let pipeInterval = 2500;
      const pipeW = 56;
      const gapBase = 150;
      const gapMin = 120;
      let speed = 2.8;

      // Temas de fondo (colores y estilos por nivel)
      const backgrounds = [
        { starColor: 'rgba(255,255,255,.04)', bgGradient: 'radial-gradient(1200px 800px at 70% -10%, #1f2430, #0e0f12)' }, // Nivel 0: Noche oscura
        { starColor: 'rgba(173,216,230,.04)', bgGradient: 'radial-gradient(1200px 800px at 70% -10%, #87CEEB, #4682B4)' }, // Nivel 1: Cielo azul
        { starColor: 'rgba(255,165,0,.04)', bgGradient: 'radial-gradient(1200px 800px at 70% -10%, #FFD700, #FF8C00)' }, // Nivel 2: Atardecer naranja
        { starColor: 'rgba(144,238,144,.04)', bgGradient: 'radial-gradient(1200px 800px at 70% -10%, #32CD32, #228B22)' }, // Nivel 3: Bosque verde
        { starColor: 'rgba(255,105,180,.04)', bgGradient: 'radial-gradient(1200px 800px at 70% -10%, #FF69B4, #C71585)' }  // Nivel 4: Rosa futurista
      ];

      // Utilidades
      function rand(min, max){ return Math.random() * (max - min) + min; }

      // Sonidos
      let ac, beepGain;
      function initAudio(){
        if (ac) return;
        ac = new (window.AudioContext || window.webkitAudioContext)();
        beepGain = ac.createGain();
        beepGain.gain.value = 0.05;
        beepGain.connect(ac.destination);
      }
      function bip(freq, dur){
        if(muted) return;
        try{
          initAudio();
          const o = ac.createOscillator();
          o.type = 'square';
          o.frequency.value = freq;
          o.connect(beepGain);
          const now = ac.currentTime;
          o.start(now);
          o.stop(now + dur);
        }catch(e){}
      }

      // Entrada
      function flap(){
        if (state === 'idle') start();
        if (state !== 'playing') return;
        player.vy = FLAP;
        bip(700, 0.06);
      }
      window.addEventListener('keydown', (e)=>{
        if (e.code === 'Space') { e.preventDefault(); flap(); }
        else if (e.key.toLowerCase() === 'p') togglePause();
        else if (e.key.toLowerCase() === 'r') restart();
        else if (e.key.toLowerCase() === 'h') goHome();
      }, {passive:false});
      canvas.addEventListener('mousedown', flap);
      canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); flap(); }, {passive:false});

      // Controles HUD
      pauseBtn.addEventListener('click', togglePause);
      restartBtn.addEventListener('click', restart);
      startBtn.addEventListener('click', prepareStart);
      muteBtn.addEventListener('click', ()=>{
        muted = !muted;
        if(!muted) initAudio();
        muteBtn.textContent = 'Sonido: ' + (muted ? 'Off' : 'On');
      });
      playAgainBtn.addEventListener('click', restart);
      leaderboardBtn.addEventListener('click', showLeaderboard);
      closeLeaderboardBtn.addEventListener('click', () => { leaderboardOverlay.style.display = 'none'; });
      homeBtn.addEventListener('click', goHome);
      homeGameOverBtn.addEventListener('click', goHome);

      function prepareStart(){
        playerName = document.getElementById('playerNameInput').value.trim();
        if (!playerName) {
          alert('Ingresa un nombre para jugar.');
          return;
        }
        startOverlay.style.display = 'none';
        resetGame();
        startCountdown();
      }

      function startCountdown(){
        countdownOverlay.style.display = 'grid';
        let count = 3;
        const countdownTexts = ['3', '2', '1', '¬°Vamos!'];
        function showNext(){
          if (count < 0) {
            countdownOverlay.style.display = 'none';
            state = 'playing';
            lastTime = performance.now();
            requestAnimationFrame(loop);
            return;
          }
          countdownOverlay.textContent = countdownTexts[3 - count];
          countdownOverlay.classList.remove('show');
          setTimeout(() => {
            countdownOverlay.classList.add('show');
          }, 50);
          bip(500, 0.1);
          count--;
          setTimeout(showNext, 1000);
        }
        showNext();
      }

      function togglePause(){
        if (state === 'playing') { state = 'paused'; pauseBtn.textContent = '‚ñ∂ Reanudar'; }
        else if (state === 'paused') { state = 'playing'; lastTime = performance.now(); pauseBtn.textContent = '‚è∏ Pausa'; requestAnimationFrame(loop); }
      }
      function restart(){
        resetGame();
        state = 'playing';
        startOverlay.style.display = 'none';
        gameOverOverlay.style.display = 'none';
        lastTime = performance.now();
        requestAnimationFrame(loop);
      }
      function goHome(){
        state = 'idle';
        startOverlay.style.display = 'grid';
        gameOverOverlay.style.display = 'none';
        leaderboardOverlay.style.display = 'none';
        resetGame();
      }
      function gameOver(){
        state = 'gameover';
        bip(180, 0.12);
        finalScore.textContent = score;
        finalBest.textContent = best;
        gameOverOverlay.style.display = 'grid';

        if (playerName && score > 0) {
          axios.post(SHEETDB_API_URL, {
            data: [{
              name: playerName,
              score: score,
              date: new Date().toISOString()
            }]
          }).then(() => {
            console.log('Puntaje guardado');
          }).catch(err => {
            console.error('Error al guardar:', err);
          });
        }
      }

      function resetGame(){
        player.y = canvas.height/2/ (window.devicePixelRatio || 1);
        player.vy = 0;
        score = 0; scoreEl.textContent = score;
        speed = 2.8;
        pipeInterval = 2500;
        pipes.length = 0;
        pipeTimer = 0;
        currentLevel = 0;
        canvas.style.background = backgrounds[0].bgGradient;
      }

      function drawBackground(t){
        const level = Math.floor(score / 10) % backgrounds.length;
        if (level !== currentLevel) {
          currentLevel = level;
          canvas.style.background = backgrounds[level].bgGradient;
          bip(600, 0.1);
        }
        ctx.save();
        ctx.fillStyle = backgrounds[level].starColor;
        for (let i=0;i<60;i++){
          const x = (i*73 + (t*0.03)) % (canvas.width/ (window.devicePixelRatio||1));
          const y = (i*47 % (canvas.height/ (window.devicePixelRatio||1)));
          ctx.fillRect(x, y, 2, 2);
        }
        ctx.restore();
      }
      function drawPlayer(){
        const {x, y, r} = player;
        if (imageLoaded && playerImage.complete) {
          const imgSize = r * 2;
          ctx.drawImage(playerImage, x - imgSize / 2, y - imgSize / 2, imgSize, imgSize);
        } else {
          ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fillStyle = '#fbbf24'; ctx.fill();
          ctx.beginPath(); ctx.arc(x + r*0.35, y - r*0.2, r*0.22, 0, Math.PI*2); ctx.fillStyle = '#111827'; ctx.fill();
          ctx.beginPath();
          ctx.moveTo(x - r*0.2, y);
          ctx.lineTo(x - r*1.2, y - r*0.5);
          ctx.lineTo(x - r*1.2, y + r*0.5);
          ctx.closePath();
          ctx.fillStyle = '#fb7185';
          ctx.fill();
        }
      }
      function drawPipes(){
        ctx.fillStyle = '#22c55e';
        pipes.forEach(p=>{
          ctx.fillRect(p.x, 0, pipeW, p.top);
          const bottomY = p.top + p.gap;
          ctx.fillRect(p.x, bottomY, pipeW, canvas.height - bottomY);
        });
      }

      function spawnPipe(){
        const ch = canvas.height / (window.devicePixelRatio || 1);
        const gap = Math.max(gapMin, gapBase - score * 1.2);
        const margin = 40;
        const top = Math.max(margin, Math.min(ch - margin - gap, rand(margin, ch - margin - gap)));
        pipes.push({ x: canvas.width/(window.devicePixelRatio||1) + 10, top, gap, passed:false });
      }

      function rectCircleCollide(cx, cy, cr, rx, ry, rw, rh){
        const nx = Math.max(rx, Math.min(cx, rx+rw));
        const ny = Math.max(ry, Math.min(cy, ry+rh));
        const dx = cx - nx, dy = cy - ny;
        return dx*dx + dy*dy < cr*cr;
      }

      function showLeaderboard(){
        axios.get(`${SHEETDB_API_URL}?sort_by=score&sort_order=desc&limit=10`).then(response => {
          leaderboardTable.innerHTML = '';
          const scores = response.data;
          if (scores.length === 0) {
            leaderboardTable.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:8px; color:var(--muted);">No hay puntajes a√∫n.</td></tr>';
          } else {
            scores.forEach(s => {
              const row = document.createElement('tr');
              row.innerHTML = `<td style="padding:8px;">${s.name}</td><td style="text-align:right; padding:8px;">${s.score}</td>`;
              leaderboardTable.appendChild(row);
            });
          }
          leaderboardOverlay.style.display = 'grid';
        }).catch(err => {
          console.error('Error al cargar:', err);
          leaderboardTable.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:8px; color:var(--danger);">Error al cargar.</td></tr>';
        });
      }

      let lastTime = performance.now();
      function loop(now){
        if (state !== 'playing') return;
        const dt = Math.min(34, now - lastTime);
        lastTime = now;

        pipeTimer += dt;
        if (pipeTimer > pipeInterval){
          pipeTimer = 0; spawnPipe();
          speed = Math.min(6.2, speed + 0.03);
          pipeInterval = Math.max(1200, pipeInterval - 4);
        }

        player.vy += GRAVITY;
        player.y += player.vy * dt/16.67;

        const cssW = canvas.width/(window.devicePixelRatio||1);
        for (let i=pipes.length-1; i>=0; i--){
          const p = pipes[i];
          p.x -= speed * dt/16.67;
          if (!p.passed && p.x + pipeW < player.x){
            p.passed = true; score++; scoreEl.textContent = score; bip(440, 0.05);
            if (score > best){ best = score; bestEl.textContent = best; localStorage.setItem('tapfly_best', best); }
          }
          if (p.x + pipeW < -10) pipes.splice(i,1);

          if (
            rectCircleCollide(player.x, player.y, player.r, p.x, 0, pipeW, p.top) ||
            rectCircleCollide(player.x, player.y, player.r, p.x, p.top+p.gap, pipeW, canvas.height)
          ){
            gameOver();
          }
        }

        if (player.y - player.r < -20 || player.y + player.r > canvas.height/(window.devicePixelRatio||1) + 20){
          gameOver();
        }

        ctx.clearRect(0,0,canvas.width,canvas.height);
        drawBackground(now);
        drawPipes();
        drawPlayer();

        requestAnimationFrame(loop);
      }

      startOverlay.style.display = 'grid';
      requestAnimationFrame(ts => { lastTime = ts; });
      canvas.addEventListener('click', ()=>{ if (state === 'gameover') restart(); });
    })();
  </script>
</body>
</html>